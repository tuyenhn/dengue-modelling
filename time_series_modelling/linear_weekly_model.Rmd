---
title: "Dengue weekly incidence modelling"
output: 
  html_document:
    df_print: paged
    toc: yes
    theme: journal
---

**Knitted at: `r Sys.time()`**

# Libraries

```{r message=FALSE, warning=FALSE}
library(tidyverse)
library(magrittr)

library(feasts)
library(tsibble)
library(fable.prophet)
library(fabletools)
library(fable)

library(lubridate)

library(ggdist)

library(sf)
library(stars)
```

# Settings
```{r}
theme_set(theme_bw())
```


# Data ingestion

```{r}
source("./data_weekly.R")
```


## Incidence data

```{r}
ggplot(incidence_weekly_df, aes(x = date_admitted, y = n)) +
  geom_line() +
  scale_x_yearweek("Week of admission") +
  scale_y_continuous("Case admitted") +
  ggtitle("Dengue weekly incidence")


ggsave("weekly_incidence_ts.svg", width = 12, height = 7)
```

## HCMC shape

```{r}
ggplot() +
  geom_sf(data = hcmc_shp_w_buff) +
  geom_sf(data = hcmc_shp)
```

## Weather data

Data information: ![](era5_req.png)
```{r}
raw_weather
```

### Temperature data

```{r}
hcmc_temp_df %>%
  ggplot(aes(x = date, y = t2m)) +
  geom_line() +
  geom_smooth() +
  scale_x_yearweek("Week") +
  scale_y_continuous("2m temperature") +
  ggtitle("Weekly 2m temperature ERA5 reanalysis")

ggsave("weekly_t2m_ts.svg", width = 10, height = 7)

hist(hcmc_temp_df$t2m)
```

### Precipitation data

```{r}
hcmc_precip_df %>%
  ggplot(aes(x = date, y = precip)) +
  geom_line() +
  geom_smooth() +
  scale_x_yearweek("Week") +
  scale_y_continuous("Total precipitation") +
  ggtitle("Weekly Total precipitation ERA5 reanalysis")

ggsave("weekly_precip_ts.svg", width = 10, height = 7)

hist(hcmc_precip_df$precip)
```

```{r}
incidence_weekly_weather_df
```

# Time series analysis

## STL Decomposition

```{r}
incidence_weekly_df %>%
  model(
    stl_decomp = STL(n ~ season(period = 52, window = "periodic"), robust = TRUE)
  ) %>%
  components() %>%
  autoplot() + xlab("Date")

ggsave("decomp_stl_additive.svg", width = 10, height = 7)


# incidence_weekly_df %>%
#   model(
#     stl_decomp = STL(log(n) ~ season(period = 52, window = "periodic"), robust = TRUE)
#   ) %>%
#   components() %>%
#   autoplot()
```


## Homoscedasticity

```{r}
skedastic::white(lm(n ~ date_admitted, data = train_weekly_df))
```

```{r}
boxcox_mle <- unclass(MASS::boxcox(lm(n ~ date_admitted, data = train_weekly_df))) %>% as_tibble()

boxcox_white_df <- map(boxcox_mle$x, \(lambda) {
  tibble(
    lambda = lambda,
    transformed_x = list(box_cox(train_weekly_df$n, lambda)),
    white_pvalue = skedastic::white(
      lm(unlist(transformed_x) ~ train_weekly_df$date_admitted)
    )$p.value
  )
}) %>%
  list_c()

boxcox_white_df %>%
  left_join(boxcox_mle, by = c("lambda" = "x")) %>%
  ggplot(aes(x = lambda)) +
  geom_line(aes(y = white_pvalue), color = "red") +
  geom_line(aes(y = (y - min(y)) / 1000000), color = "blue") +
  scale_y_continuous(
    "White test p-value",
    sec.axis = sec_axis(trans = ~ . * 1000000 + min(boxcox_mle$y), name = "log-Likelihood")
  )
```

```{r}
white_lambda <- boxcox_white_df %>%
  filter(lambda > -1) %>%
  filter(white_pvalue == max(white_pvalue)) %>%
  pull(lambda)
boxcox_lambda <- boxcox_mle %>%
  filter(y == max(y)) %>%
  pull(x)
guerrero_lambda <- train_weekly_df %>%
  features(n, features = guerrero) %>%
  pull(lambda_guerrero)

white_lambda
boxcox_lambda
guerrero_lambda
```

## Log transformation

```{r}
incidence_weekly_df %<>% mutate(n = log(n))
train_weekly_df %<>% mutate(n = log(n))
test_weekly_df %<>% mutate(n = log(n))

ggplot(incidence_weekly_df, aes(x = date_admitted, y = n)) +
  geom_line() +
  xlab("Date") +
  ylab("Log-transformed incidence")

ggsave("weekly_incidence_log_trans.svg", width = 10, height = 7)
```


```{r}
train_weekly_weather_df %<>% mutate(n = log(n))
test_weekly_weather_df %<>% mutate(n = log(n))
```

# Modelling

## Misc

### Performance checking framework

```{r}
fit_perf <- function(fit, actual) {
  print(summary(fit))

  fitted <- fitted(fit)

  fitted %>% plot(type = "l")

  print(sprintf(
    "Train RMSE: %f",
    sqrt(mean((actual - fitted)^2))
  ))
  print(sprintf(
    "Train MAE: %f",
    mean(abs(actual - fitted))
  ))

  print(train_weekly_weather_df %>%
    mutate(fitted = fitted) %>%
    ggplot(aes(x = date_admitted)) +
    geom_line(aes(y = n)) +
    geom_line(aes(y = fitted), color = "red"))
}

model_perfs <- tibble(
  model = character(),
  RMSE = numeric(),
  MAE = numeric()
)

forecast_perf <- function(forecast, model_name, h = NULL, new_data = NULL) {
  if (!is.null(h) && !is.null(new_data)) {
    warn("Input forecast horizon `h` will be ignored as `new_data` has been provided.")
    h <- NULL
  }

  if (inherits(forecast, "mdl_df")) {
    forecast <- forecast %>%
      forecast(h = h, new_data = new_data) %>%
      as_tibble(.name_repair = "check_unique") %>%
      pull(.mean)
  }

  forecast %<>% exp()

  forecast %>% plot(type = "l")

  actual <- test_weekly_df %>%
    pull(n) %>%
    exp()

  rmse <- sqrt(mean((actual - forecast)^2))
  mae <- mean(abs(actual - forecast))

  print(sprintf("Test RMSE: %f", rmse))
  print(sprintf("Test MAE: %f", mae))

  model_perfs <<- model_perfs %>%
    bind_rows(tibble(model = model_name, RMSE = rmse, MAE = mae))

  print(test_weekly_df %>%
    mutate(forecast = forecast, actual = actual) %>%
    ggplot(aes(x = date_admitted)) +
    geom_line(aes(y = actual)) +
    geom_line(aes(y = forecast), color = "red"))
}
```

### Forecast plotting
```{r}
mrdp <- train_weekly_df %>% tail(1)
mrdp_ci <- distributional::dist_normal(mrdp$n, 0)
dimnames(mrdp_ci) <- "n"

forecast_layer <- function(fit, h = NULL, new_data = NULL) {
  if (!is.null(h) && !is.null(new_data)) {
    warn("Input forecast horizon `h` will be ignored as `new_data` has been provided.")
    h <- NULL
  }

  fit %>%
    forecast(h = h, new_data = new_data) %>%
    append_row(-1) %>%
    mutate(
      n = case_when(is.na(n) ~ mrdp_ci, .default = n) %>% exp(),
      .mean = case_when(is.na(.mean) ~ mrdp$n, .default = .mean) %>% exp(),
    ) %>%
    as_fable(c(".mean"), "n") %>%
    autolayer()
}
```


### Differencing

Quickly check if any differencing needed, both seasonal and non-seasonal

```{r}
train_weekly_df %>% features(n, unitroot_ndiffs)
train_weekly_df %>% features(n, unitroot_nsdiffs)
```

```{r}
train_weekly_df %>%
  gg_tsdisplay(
    difference(n),
    plot_type = "partial",
    lag = 52
  )

train_weekly_df %>%
  gg_tsdisplay(
    difference(n, 52),
    plot_type = "partial",
    lag = 208
  )
```

## ARIMA weekly

### Model fitting

```{r}
arima_fits <- train_weekly_df %>% model(
  auto_arima = ARIMA(n ~ pdq(3, 1, 3) + PDQ(0, 0, 0))
)
```

```{r}
report(arima_fits)

accuracy(arima_fits)

# residuals
arima_fits %>% gg_tsresiduals(lag = 104)

fit_resid <- arima_fits %>%
  residuals() %>%
  as_tibble()

shapiro.test(fit_resid$.resid)
skedastic::white(lm(.resid ~ date_admitted, data = fit_resid))
```


```{r}
train_weekly_df %>%
  mutate(fitted = fitted(arima_fits)$.fitted) %>%
  ggplot(aes(x = date_admitted)) +
  geom_line(aes(y = n)) +
  geom_line(aes(y = fitted), color = "red", alpha = 0.8)
```

### Forecast

```{r}
forecast_p <- ggplot(incidence_weekly_df, aes(x = date_admitted, y = exp(n))) +
  forecast_layer(arima_fits, h = 4) +
  geom_line() +
  scale_x_yearweek("Week", limits = c(as.Date("2018-01-01"), as.Date("2019-01-21"))) +
  scale_y_continuous("Incidence") +
  ggtitle("4 week forecast - ARIMA")

forecast_p

ggsave("forecast_arima_4w.svg", width = 10, height = 7)
```


```{r}
forecast_perf(arima_fits, h = 4, "ARIMA(3,1,3)")
```



## ARIMAX weekly

### Model fitting

```{r}
arimax_fits <- train_weekly_weather_df %>% model(
  auto_arima_t2m = ARIMA(n ~ xreg(t2m) + pdq(3, 1, 3) + PDQ(0, 0, 0)),
  auto_arima_precip = ARIMA(n ~ xreg(precip) + pdq(3, 1, 3) + PDQ(0, 0, 0)),
  auto_arima_weather = ARIMA(n ~ xreg(t2m, precip) + pdq(3, 1, 3) + PDQ(0, 0, 0))
)
```

```{r}
report(arimax_fits)

accuracy(arimax_fits)

fit <- arimax_fits %>% select(auto_arima_weather)

# residuals
fit %>% gg_tsresiduals(lag = 104)

fit_resid <- fit %>%
  residuals() %>%
  as_tibble()

shapiro.test(fit_resid$.resid)
skedastic::white(lm(.resid ~ date_admitted, data = fit_resid))
```


```{r}
train_weekly_df %>%
  mutate(fitted = fitted(fit)$.fitted) %>%
  ggplot(aes(x = date_admitted)) +
  geom_line(aes(y = n)) +
  geom_line(aes(y = fitted), color = "red", alpha = 0.8)
```

### Forecast

```{r}
forecast_p <- ggplot(incidence_weekly_df, aes(x = date_admitted, y = exp(n))) +
  forecast_layer(arimax_fits, new_data = test_weekly_weather_df) +
  geom_line() +
  scale_x_yearweek("Week", limits = c(as.Date("2018-01-01"), as.Date("2019-01-21"))) +
  scale_y_continuous("Incidence") +
  ggtitle("4 week forecast - ARIMA")

forecast_p

ggsave("forecast_arimaxs_4w.svg", width = 10, height = 7)

forecast_p +
  facet_wrap(~.model, ncol = 3) +
  scale_x_yearweek("Week", limits = c(as.Date("2018-12-01"), as.Date("2019-01-21")))

ggsave("forecast_arimaxs_facet_4w.svg", width = 10, height = 7)
```


```{r}
forecast_perf(
  arimax_fits %>% select(auto_arima_precip),
  new_data = test_weekly_weather_df,
  "ARIMA(3,1,3) + Precip"
)
cat("\n")

forecast_perf(
  arimax_fits %>% select(auto_arima_t2m),
  new_data = test_weekly_weather_df,
  "ARIMA(3,1,3) + T2m"
)
cat("\n")

forecast_perf(
  arimax_fits %>% select(auto_arima_weather),
  new_data = test_weekly_weather_df,
  "ARIMA(3,1,3) + Weather"
)
```



## SARIMA weekly

### Model fitting

```{r}
future::plan(future::multisession)

sarima_fits <- train_weekly_df %>% model(
  auto_arima = ARIMA(n ~ pdq(2, 0, 1) + PDQ(1, 1, 0)),

  # same as auto_arima but with non-seasonal differencing
  arima_211110 = ARIMA(n ~ pdq(2, 1, 1) + PDQ(1, 1, 0)),

  # same as auto_arima but with non-seasonal differencing and more AR
  arima_411110 = ARIMA(n ~ pdq(4, 1, 1) + PDQ(1, 1, 0)),
)

future::plan(future::sequential())
```

```{r}
report(sarima_fits)

sarima_fits %>% pivot_longer(everything(),
  names_to = "Model name",
  values_to = "Orders"
)

accuracy(sarima_fits)

fit <- sarima_fits %>% select(auto_arima)

# residuals
fit %>% gg_tsresiduals(lag = 104)

fit_resid <- fit %>%
  residuals() %>%
  as_tibble()

shapiro.test(fit_resid$.resid)
skedastic::white(lm(.resid ~ date_admitted, data = fit_resid))
```

```{r}
sarima_fits %>%
  augment() %>%
  features(.innov, ljung_box, lag = min(2 * 52, nrow(train_weekly_df) / 5))
```

```{r}
train_weekly_df %>%
  mutate(fitted = fitted(fit)$.fitted) %>%
  ggplot(aes(x = date_admitted)) +
  geom_line(aes(y = n)) +
  geom_line(aes(y = fitted), color = "red", alpha = 0.8)
```


### Forecast

```{r}
forecast_p <- ggplot(incidence_weekly_df, aes(x = date_admitted, y = exp(n))) +
  forecast_layer(sarima_fits, h = 4) +
  geom_line() +
  scale_x_yearweek("Week", limits = c(as.Date("2018-01-01"), as.Date("2019-01-21"))) +
  scale_y_continuous("Incidence") +
  ggtitle("4 week forecast - SARIMA")

forecast_p

ggsave("forecast_sarimas_4w.svg", width = 10, height = 7)

forecast_p +
  facet_wrap(~.model, ncol = 3) +
  scale_x_yearweek("Week", limits = c(as.Date("2018-12-01"), as.Date("2019-01-21")))

ggsave("forecast_sarimas_facet_4w.svg", width = 10, height = 7)
```


```{r}
forecast_perf(
  sarima_fits %>% select(arima_211110),
  h = 4,
  "SARIMA(2,1,1)(1,1,0)"
)
cat("\n")

forecast_perf(
  sarima_fits %>% select(arima_411110),
  h = 4,
  "SARIMA(4,1,1)(1,1,0)"
)
cat("\n")

forecast_perf(
  sarima_fits %>% select(auto_arima),
  h = 4,
  "SARIMA(2,0,1)(1,1,0)"
)
```

## SARIMA one-week-ahead

```{r}
# fit <- sarima_fits %>% select(arima_411110)
# report(fit)
#
# forecast_1w_df <- train_weekly_df %>%
#   mutate(ci = NA)
#
# for (i in 1:4) {
#   forecasted_1w <- fit %>%
#     forecast(h = 1) %>%
#     as_tibble() %>%
#     select(date_admitted, .mean, n) %>%
#     rename(ci = n, n = .mean)
#
#   forecast_1w_df %<>% bind_rows(forecasted_1w)
#
#   fit %<>%
#     refit(
#       forecast_1w_df,
#       reestimate = FALSE
#     )
# }
#
# ggplot(mapping = aes(x = date_admitted)) +
#   stat_lineribbon(
#     data = forecast_1w_df,
#     aes(ydist = ci),
#     linewidth = .5,
#     .width = c(0.8, 0.95),
#     color = "blue"
#   ) +
#   geom_line(
#     data = incidence_weekly_df,
#     aes(y = n)
#   ) +
#   scale_fill_brewer() +
#   scale_y_continuous(limits = c(6, 8)) +
#   scale_x_yearweek(
#     limit = c(as.Date("2018-12-01"), as.Date("2019-02-01"))
#   )
```

### Accuracy

```{r}
# actual <- test_weekly_df$n
# forecasted <- forecast_1w_df %>%
#   filter(year(date_admitted) == 2019) %>%
#   head(4) %>%
#   pull(n)
#
# sprintf("RMSE: %f", sqrt(mean((actual - forecasted)^2)))
# sprintf("MAE: %f", mean(abs(actual - forecasted)))
```

## Prophet weekly

```{r}
prophet_weekly <- train_weekly_df %>%
  model(
    prophet_addi = prophet(n ~ season(period = 52, order = 10, type = "additive")),
    prophet_multi = prophet(n ~ season(period = 52, order = 10, type = "multiplicative"))
  )

prophet_forecast_p <- ggplot(incidence_weekly_df, aes(x = date_admitted, y = exp(n))) +
  forecast_layer(prophet_weekly, h = 4) +
  geom_line() +
  scale_x_yearweek("Week", limits = c(as.Date("2018-01-01"), as.Date("2019-01-21"))) +
  scale_y_continuous("Incidence") +
  ggtitle("4 week forecast - Prophet")

prophet_forecast_p

ggsave("forecast_prophets_4w.svg", width = 10, height = 7)

prophet_forecast_p + facet_wrap(~.model, ncol = 2) +
  scale_x_yearweek("Week", limits = c(as.Date("2018-12-01"), as.Date("2019-01-21")))

ggsave("forecast_prophets_facet_4w.svg", width = 10, height = 7)
```

```{r}
forecast_perf(
  prophet_weekly %>% select(prophet_addi),
  h = 4,
  "Prophet additive"
)
cat("\n")

forecast_perf(
  prophet_weekly %>% select(prophet_multi),
  h = 4,
  "Prophet multiplicative"
)
```

### With exogenous regressors


```{r}
prophet_xreg_weekly <- train_weekly_weather_df %>%
  model(
    prophet_t2m = prophet(n ~ xreg(t2m) + season(period = 52, order = 10, type = "multiplicative")),
    prophet_precip = prophet(n ~ xreg(precip) + season(period = 52, order = 10, type = "multiplicative")),
    prophet_weather = prophet(n ~ xreg(t2m) + xreg(precip) + season(period = 52, order = 10, type = "multiplicative"))
  )

prophet_forecast_p <- ggplot(incidence_weekly_df, aes(x = date_admitted, y = exp(n))) +
  forecast_layer(prophet_xreg_weekly, new_data = test_weekly_weather_df) +
  geom_line() +
  scale_x_yearweek("Week", limits = c(as.Date("2018-01-01"), as.Date("2019-01-21"))) +
  scale_y_continuous("Incidence") +
  ggtitle("4 week forecast - Prophet + xregs")

prophet_forecast_p

ggsave("forecast_xreg_prophets_4w.svg", width = 10, height = 7)

prophet_forecast_p + facet_wrap(~.model) +
  scale_x_yearweek("Week", limits = c(as.Date("2018-12-01"), as.Date("2019-01-21")))

ggsave("forecast_xreg_prophets_facet_4w.svg", width = 10, height = 7)
```

```{r}
forecast_perf(
  prophet_xreg_weekly %>% select(prophet_precip),
  new_data = test_weekly_weather_df,
  "Prophet + Precip"
)
cat("\n")

forecast_perf(
  prophet_xreg_weekly %>% select(prophet_t2m),
  new_data = test_weekly_weather_df,
  "Prophet + T2m"
)
cat("\n")

forecast_perf(
  prophet_xreg_weekly %>% select(prophet_weather),
  new_data = test_weekly_weather_df,
  "Prophet + Weather"
)
```


### With holidays

```{r fig.height=15, fig.width=15, warning=FALSE}
pub_holidays <- map(2000:2022, \(year){
  c(
    sprintf("%d-01-01", year),
    sprintf("%d-12-29", subtract(year, 1)) %>% lunR::lunar_to_gregorian(),
    sprintf("%d-03-10", year) %>% lunR::lunar_to_gregorian(),
    sprintf("%d-04-30", year),
    sprintf("%d-05-01", year),
    sprintf("%d-09-02", year)
  )
}) %>%
  list_c() %>%
  as.Date()

vn_pub_holidays <- tsibble(
  date = pub_holidays,
  holiday = rep(
    c("New Year", "Tet", "Hung King", "Reunification", "Labor Day", "Independence Day"),
    23
  ),
  lower_window = rep(c(0, 0, 0, 0, 0, 0), 23),
  upper_window = rep(c(1, 7, 1, 1, 1, 2), 23),
  index = date
)

vn_pub_holidays_train <- vn_pub_holidays %>% filter(year(date) < 2019)

incidence_weekly_df %>%
  mutate(year = year(date_admitted)) %>%
  autoplot() +
  geom_vline(data = vn_pub_holidays, aes(xintercept = date), color = "red", alpha = 0.3) +
  facet_wrap(~year, scales = "free_x")
```

```{r}
prophet_weekly_w_holiday <- train_weekly_df %>%
  model(
    prophet_w_holiday = prophet(
      n ~ season(period = 52, order = 10, type = "additive") +
        holiday(vn_pub_holidays_train)
    )
  )

prophet_forecast_p <- ggplot(incidence_weekly_df, aes(x = date_admitted, y = exp(n))) +
  forecast_layer(prophet_weekly_w_holiday, new_data = test_weekly_df) +
  geom_line() +
  geom_vline(data = vn_pub_holidays, aes(xintercept = date), color = "red", alpha = 0.3) +
  scale_x_yearweek("Week", limits = c(as.Date("2018-01-01"), as.Date("2019-01-21"))) +
  scale_y_continuous("Incidence") +
  ggtitle("4 week forecast - Prophet + holidays")

prophet_forecast_p

ggsave("forecast_holidays_prophets_4w.svg", width = 10, height = 7)
```

```{r}
forecast_perf(
  prophet_weekly_w_holiday,
  new_data = test_weekly_weather_df,
  "Prophet + holidays"
)
```


## SARIMAX

SARIMAX - Seasonal Auto-Regressive Integrated Moving Average with eXogenous factors

### Model fitting

```{r}
future::plan(future::multisession)

sarimax_fits <- train_weekly_weather_df %>% model(
  # raw covariables
  arima_411110_t2m = ARIMA(n ~ xreg(t2m) + pdq(4, 1, 1) + PDQ(1, 1, 0)),
  arima_411110_precip = ARIMA(n ~ xreg(precip) + pdq(4, 1, 1) + PDQ(1, 1, 0)),

  # unit root issues so this model will be auto_arima
  auto_arima_weather = ARIMA(n ~ xreg(precip, t2m) + pdq(2, 0, 1) + PDQ(1, 1, 0)),
)

future::plan(future::sequential)
```

### Fit performance

```{r warning=FALSE}
report(sarimax_fits)

accuracy(sarimax_fits)

sarimax_fit <- sarimax_fits %>% select(auto_arima_weather)

# residuals
sarimax_fit %>% gg_tsresiduals(lag = 104)

fit_resid <- sarimax_fit %>%
  residuals() %>%
  as_tibble()

shapiro.test(fit_resid$.resid)
skedastic::white(lm(.resid ~ date_admitted, data = fit_resid))


sarimax_fit %>%
  augment() %>%
  features(.innov, ljung_box, lag = min(2 * 52, nrow(train_weekly_df) / 5), dof = 3)
```

```{r}
fitted_sarimax_p <- fitted(sarimax_fit) %>%
  autoplot() +
  geom_line(
    data = train_weekly_df,
    mapping = aes(x = date_admitted, y = n),
    color = "red", alpha = 0.7
  )

fitted_sarimax_p

fitted_sarimax_p +
  scale_x_yearweek(limits = c(as.Date("2018-01-01"), as.Date("2019-01-01")))
```


### Forecasting

```{r}
forecast_p <- ggplot(incidence_weekly_df, aes(x = date_admitted, y = exp(n))) +
  forecast_layer(sarimax_fits, new_data = test_weekly_weather_df) +
  geom_line() +
  scale_x_yearweek("Week", limits = c(as.Date("2018-01-01"), as.Date("2019-01-21"))) +
  scale_y_continuous("Incidence") +
  ggtitle("4 week forecast - SARIMAX")

forecast_p

ggsave("forecast_sarimaxs_4w.svg", width = 10, height = 7)

forecast_p +
  facet_wrap(~.model) +
  scale_x_yearweek("Week", limits = c(as.Date("2018-12-01"), as.Date("2019-01-21")))

ggsave("forecast_sarimaxs_facet_4w.svg", width = 10, height = 7)
```

```{r}
for (model in sort(colnames(sarimax_fits))) {
  forecast_perf(
    sarimax_fits %>% select(all_of(model)),
    new_data = test_weekly_weather_df,
    as.character(model)
  )
  cat("\n")
}
```


# Comparison
```{r}
model_perfs
```

```{r}
model_perfs %>% write_csv("arima_models_perf.csv")
```
