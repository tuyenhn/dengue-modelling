---
title: "Dengue weekly incidence modelling"
output: 
  html_document:
    df_print: paged
    toc: yes
    theme: journal
---

**Knitted at: `r Sys.time()`**

# Libraries

```{r message=FALSE, warning=FALSE}
library(tidyverse)
library(magrittr)

library(feasts)
library(tsibble)
library(fable.prophet)
library(fabletools)
library(fable)

library(lubridate)

library(ggdist)

library(sf)
library(stars)
```

# Settings
```{r}
# theme_set(ggthemes::)
```

# Data ingestion

## Incidence data

```{r}
incidence_raw <- read_csv("../incidence_ts_in.csv", show_col_types = FALSE) %>%
  mutate(date_admitted = as.Date(date_admitted)) %>%
  as_tsibble(index = date_admitted) %>%
  fill_gaps(n = 0)

incidence_weekly_df <- incidence_raw %>%
  index_by(agg = ~ yearweek(.)) %>%
  summarise(n = sum(n)) %>%
  rename(date_admitted = agg)

train_weekly_df <- incidence_weekly_df %>%
  filter(year(date_admitted) < 2019)

ggplot(incidence_weekly_df, aes(x = date_admitted, y = n)) +
  geom_line()
```

## HCMC shape

```{r}
hcmc_shp <- read_rds("../gadm/gadm41_VNM_1_pk.rds") %>%
  terra::unwrap() %>%
  st_as_sf() %>%
  filter(GID_1 == "VNM.25_1")

hcmc_shp_w_buff <- st_buffer(hcmc_shp, units::set_units(10, "km"))
```

## Temperature data

Temperature data information: ![](temp_era5_req.png)

```{r}
hcmc_temp_df <- read_stars("../2m_temp_HCMC.nc") %>%
  st_set_crs(4326) %>%
  aggregate("1 week", FUN = mean) %>%
  aggregate(hcmc_shp_w_buff, FUN = mean) %>%
  as_tibble() %>%
  select(time, `2m_temp_HCMC.nc`) %>%
  rename(date = time, t2m = `2m_temp_HCMC.nc`) %>%
  mutate(
    date = as.Date(date) %>% yearweek(),
    t2m = t2m - 273.15,
    scaled_t2m = scale(t2m)
  ) %>%
  as_tsibble()

hcmc_temp_df %>%
  ggplot(aes(x = date, y = t2m)) +
  geom_line() +
  geom_smooth()

hist(hcmc_temp_df$t2m)

hist(hcmc_temp_df$scaled_t2m)
```

## Precipitation data

```{r}
hcmc_precip_df <- read_stars("../2m_precip_HCMC.nc") %>%
  st_set_crs(4326) %>%
  aggregate("1 week", FUN = sum) %>%
  aggregate(hcmc_shp_w_buff, FUN = sum) %>%
  as_tibble() %>%
  select(time, `2m_precip_HCMC.nc`) %>%
  rename(date = time, precip = `2m_precip_HCMC.nc`) %>%
  mutate(
    date = as.Date(date) %>% yearweek(),
    precip = precip * 1000,
    scaled_precip = scale(precip)
  ) %>%
  as_tsibble()

hcmc_precip_df %>%
  ggplot(aes(x = date, y = precip)) +
  geom_line() +
  geom_smooth()

hist(hcmc_precip_df$precip)

hist(hcmc_precip_df$scaled_precip)
```


# Time series analysis

## STL Decomposition

```{r}
incidence_weekly_df %>%
  model(
    stl_decomp = STL(log(n) ~ season(period = 52, window = "periodic"), robust = TRUE)
  ) %>%
  components() %>%
  autoplot()
```


## Homoscedasticity

```{r}
skedastic::white(lm(n ~ date_admitted, data = train_weekly_df))
```

```{r}
boxcox_mle <- unclass(MASS::boxcox(lm(n ~ date_admitted, data = train_weekly_df))) %>% as_tibble()

boxcox_white_df <- map(boxcox_mle$x, \(lambda) {
  tibble(
    lambda = lambda,
    transformed_x = list(box_cox(train_weekly_df$n, lambda)),
    white_pvalue = skedastic::white(
      lm(unlist(transformed_x) ~ train_weekly_df$date_admitted)
    )$p.value
  )
}) %>%
  list_c()

boxcox_white_df %>%
  left_join(boxcox_mle, by = c("lambda" = "x")) %>%
  ggplot(aes(x = lambda)) +
  geom_line(aes(y = white_pvalue), color = "red") +
  geom_line(aes(y = (y - min(y)) / 50000), color = "blue") +
  scale_y_continuous(
    "White test p-value",
    sec.axis = sec_axis(trans = ~ . * 50000 + min(boxcox_mle$y), name = "log-Likelihood")
  )
```

```{r}
white_lambda <- boxcox_white_df %>%
  filter(white_pvalue == max(white_pvalue)) %>%
  pull(lambda)
boxcox_lambda <- boxcox_mle %>%
  filter(y == max(y)) %>%
  pull(x)
guerrero_lambda <- train_weekly_df %>%
  features(n, features = guerrero) %>%
  pull(lambda_guerrero)

white_lambda
boxcox_lambda
guerrero_lambda
```

## Log transformation

```{r}
incidence_weekly_df %<>% mutate(n = log(n))
train_weekly_df %<>% mutate(n = log(n))

ggplot(incidence_weekly_df, aes(x = date_admitted, y = n)) +
  geom_line()
```

# Weekly models

## SARIMA weekly

### Differencing

Quickly check if any differencing needed, both seasonal and non-seasonal

```{r}
train_weekly_df %>% features(n, unitroot_ndiffs)
train_weekly_df %>% features(n, unitroot_nsdiffs)

train_weekly_decomp_seasonal <- train_weekly_df %>%
  model(decomp = classical_decomposition(n, type = "additive")) %>%
  components() %>%
  pull(seasonal)

train_weekly_df %>%
  mutate(n = n - train_weekly_decomp_seasonal, n = difference(n)) %>%
  pull(n) %>%
  shapiro.test()
```

```{r}
train_weekly_df %>%
  mutate(n = n - train_weekly_decomp_seasonal, n = difference(n)) %>%
  pull(n) %>%
  hist()

train_weekly_df %>%
  mutate(n = difference(n)) %>%
  pull(n) %>%
  shapiro.test()
```


```{r}
train_weekly_df %>%
  gg_tsdisplay(
    difference(n),
    plot_type = "partial",
    lag = 52
  )

train_weekly_df %>%
  gg_tsdisplay(
    difference(n, 52),
    plot_type = "partial",
    lag = 208
  )
```

### Model fitting

```{r}
future::plan(future::multisession)

sarima_fits <- train_weekly_df %>% model(
  auto_arima = ARIMA(n ~ pdq(2, 0, 1) + PDQ(1, 1, 0)),

  # same as auto_arima but with non-seasonal differencing
  arima_211110 = ARIMA(n ~ pdq(2, 1, 1) + PDQ(1, 1, 0)),

  # same as auto_arima but with non-seasonal differencing
  arima_411110 = ARIMA(n ~ pdq(4, 1, 1) + PDQ(1, 1, 0)),
)

future::plan(future::sequential())
```

```{r}
report(sarima_fits)

sarima_fits %>% pivot_longer(everything(),
  names_to = "Model name",
  values_to = "Orders"
)

accuracy(sarima_fits)

fit <- sarima_fits %>% select(auto_arima)

# residuals
fit %>% gg_tsresiduals(lag = 104)

fit_resid <- fit %>%
  residuals() %>%
  as_tibble()

shapiro.test(fit_resid$.resid)
skedastic::white(lm(.resid ~ date_admitted, data = fit_resid))
```

```{r}
sarima_fits %>%
  augment() %>%
  features(.innov, ljung_box, lag = min(2 * 52, nrow(train_weekly_df) / 5))
```

```{r}
train_weekly_df %>%
  mutate(fitted = fitted(fit)$.fitted) %>%
  ggplot(aes(x = date_admitted)) +
  geom_line(aes(y = n)) +
  geom_line(aes(y = fitted), color = "red", alpha = 0.8)
```


### Forecast

```{r}
forecasted_sarima <- forecast(sarima_fits, h = 4)

incidence_2019_weekly_df <- incidence_weekly_df %>%
  filter_index("2018-12-14" ~ "2019-02")

forecast_p <- forecasted_sarima %>%
  autoplot(incidence_2019_weekly_df) +
  scale_x_yearweek(date_breaks = "1 week", date_labels = "W%V-%Y")

forecast_p + facet_wrap(~.model, ncol = 1)
```

```{r}
forecasted_sarima %>% accuracy(incidence_2019_weekly_df)
```

## SARIMA one-week-ahead

```{r}
fit <- sarima_fits %>% select(arima_411110)
report(fit)

forecast_1w_df <- train_weekly_df %>%
  mutate(ci = NA) %>%
  as_tibble()

for (i in 1:4) {
  forecasted_1w <- fit %>%
    forecast(h = 1) %>%
    as_tibble() %>%
    select(date_admitted, .mean, n) %>%
    rename(ci = n, n = .mean)

  forecast_1w_df %<>% bind_rows(forecasted_1w)

  fit %<>%
    refit(
      incidence_weekly_df %>%
        filter_index(~ sprintf("2019 W0%d", i)) %>%
        mutate(ci = NA),
      reestimate = FALSE
    )
}

ggplot(mapping = aes(x = date_admitted)) +
  stat_lineribbon(
    data = forecast_1w_df,
    aes(ydist = ci),
    linewidth = .5,
    .width = c(0.8, 0.95),
    color = "blue"
  ) +
  geom_line(
    data = incidence_weekly_df,
    aes(y = n)
  ) +
  scale_fill_brewer() +
  scale_y_continuous(limits = c(6, 8)) +
  scale_x_yearweek(
    limit = c(as.Date("2018-12-01"), as.Date("2019-02-01"))
  )
```

### Accuracy

```{r}
actual <- incidence_weekly_df %>%
  filter(year(date_admitted) == 2019) %>%
  head(4) %>%
  pull(n)
forecasted <- forecast_1w_df %>%
  filter(year(date_admitted) == 2019) %>%
  head(4) %>%
  pull(n)

sprintf("RMSE: %f", sqrt(mean((actual - forecasted)^2)))
sprintf("MAE: %f", mean(abs(actual - forecasted)))
```

## Prophet weekly

```{r}
prophet_weekly <- train_weekly_df %>%
  model(
    prophet_addi = prophet(n ~ season(period = 52, order = 10, type = "additive")),
    prophet_multi = prophet(n ~ season(period = 52, order = 10, type = "multiplicative"))
  )

prophet_weekly_forecast <- prophet_weekly %>%
  forecast(h = 4)

prophet_forecast_p <- prophet_weekly_forecast %>%
  autoplot(incidence_2019_weekly_df) +
  scale_x_yearweek(date_breaks = "1 week", date_labels = "W%V-%Y")

prophet_forecast_p
prophet_forecast_p + facet_wrap(~.model, ncol = 1)

accuracy(prophet_weekly_forecast, incidence_2019_weekly_df)
```

### With holidays

```{r fig.height=15, fig.width=15, warning=FALSE}
pub_holidays <- map(2000:2022, \(year){
  c(
    sprintf("%d-01-01", year),
    sprintf("%d-12-29", subtract(year, 1)) %>% lunR::lunar_to_gregorian(),
    sprintf("%d-03-10", year) %>% lunR::lunar_to_gregorian(),
    sprintf("%d-04-30", year),
    sprintf("%d-05-01", year),
    sprintf("%d-09-02", year)
  )
}) %>%
  list_c() %>%
  as.Date()

vn_pub_holidays <- tsibble(
  date = pub_holidays,
  holiday = rep(
    c("New Year", "Tet", "Hung King", "Reunification", "Labor Day", "Independence Day"),
    23
  ),
  lower_window = rep(c(0, 0, 0, 0, 0, 0), 23),
  upper_window = rep(c(1, 7, 1, 1, 1, 2), 23),
  index = date
)

vn_pub_holidays_train <- vn_pub_holidays %>% filter(year(date) < 2019)

incidence_weekly_df %>%
  mutate(year = year(date_admitted)) %>%
  autoplot() +
  geom_vline(data = vn_pub_holidays, aes(xintercept = date), color = "red", alpha = 0.3) +
  facet_wrap(~year, scales = "free_x")
```

```{r}
prophet_weekly_w_holiday <- train_weekly_df %>%
  model(
    prophet_w_holiday = prophet(
      n ~ season(period = 52, order = 10, type = "additive") +
        holiday(vn_pub_holidays_train)
    )
  )

prophet_weekly_forecast <- prophet_weekly_w_holiday %>%
  forecast(h = 4)

prophet_weekly_forecast %>%
  autoplot(incidence_2019_weekly_df) +
  geom_vline(data = vn_pub_holidays, aes(xintercept = date), color = "red", alpha = 0.1)

accuracy(prophet_weekly_forecast, incidence_2019_weekly_df)
```

## SARIMAX

SARIMAX - Seasonal Auto-Regressive Integrated Moving Average with eXogenous factors

### Model fitting

```{r}
train_weekly_weather_df <- train_weekly_df %>%
  left_join(hcmc_temp_df, by = c("date_admitted" = "date")) %>%
  left_join(hcmc_precip_df, by = c("date_admitted" = "date"))

future::plan(future::multisession)

sarimax_fits <- train_weekly_weather_df %>% model(
  # raw covariables
  arima_411110_t2m = ARIMA(n ~ xreg(t2m) + pdq(4, 1, 1) + PDQ(1, 1, 0)),
  arima_411110_precip = ARIMA(n ~ xreg(precip) + pdq(4, 1, 1) + PDQ(1, 1, 0)),

  # unit root issues so this model will be auto_arima
  auto_arima_weather = ARIMA(n ~ xreg(precip, t2m) + pdq(2, 0, 1) + PDQ(1, 1, 0)),

  # scaled covariables
  arima_411110_scaled_t2m = ARIMA(n ~ xreg(scaled_t2m) + pdq(4, 1, 1) + PDQ(1, 1, 0)),
  arima_411110_scaled_precip = ARIMA(n ~ xreg(scaled_precip) + pdq(4, 1, 1) + PDQ(1, 1, 0)),
  arima_411110_scaled_weather = ARIMA(n ~ xreg(scaled_precip, scaled_t2m) + pdq(4, 1, 1) + PDQ(1, 1, 0)),
)

future::plan(future::sequential)
```

### Fit performance

```{r warning=FALSE}
report(sarimax_fits)

accuracy(sarimax_fits)

sarimax_fit <- sarimax_fits %>% select(auto_arima_weather)

# residuals
sarimax_fit %>% gg_tsresiduals(lag = 104)

fit_resid <- sarimax_fit %>%
  residuals() %>%
  as_tibble()

shapiro.test(fit_resid$.resid)
skedastic::white(lm(.resid ~ date_admitted, data = fit_resid))


sarimax_fit %>%
  augment() %>%
  features(.innov, ljung_box, lag = min(2 * 52, nrow(train_weekly_df) / 5), dof = 3)
```

```{r}
fitted_sarimax_p <- fitted(sarimax_fit) %>%
  autoplot() +
  geom_line(
    data = train_weekly_df,
    mapping = aes(x = date_admitted, y = n),
    color = "red", alpha = 0.7
  )

fitted_sarimax_p

fitted_sarimax_p +
  scale_x_yearweek(limits = c(as.Date("2018-01-01"), as.Date("2019-01-01")))
```


### Forecasting

```{r}
incidence_weekly_weather_df <- incidence_weekly_df %>%
  left_join(
    hcmc_temp_df,
    by = c("date_admitted" = "date")
  ) %>%
  left_join(
    hcmc_precip_df,
    by = c("date_admitted" = "date")
  )

test_weekly_weather_df <- incidence_weekly_weather_df %>%
  filter(year(date_admitted) == 2019) %>%
  head(4)

forecasted_sarimax <- forecast(
  sarimax_fits,
  new_data = test_weekly_weather_df
)

forecast_p <- forecasted_sarimax %>%
  autoplot(incidence_weekly_weather_df) +
  scale_x_yearweek(
    "Date",
    date_breaks = "1 week", date_labels = "W%V-%Y",
    limit = c(as.Date("2018-12-01"), as.Date("2019-02-01"))
  ) +
  scale_y_continuous("Incidence (log10-transformed)", limits = c(5.5, 8)) +
  scale_alpha_continuous("Confidence interval")

forecast_p

forecast_p + facet_wrap(~.model, ncol = 2, scales = "free_y")

accuracy(forecasted_sarimax, test_weekly_weather_df)

ggsave("sarimax_4w_forecasts.png", width = 10, height = 7)
```

#### One-week-ahead

```{r}
fit <- sarimax_fits %>% select(arima_411110_precip)

forecast_1w_weather_df <- train_weekly_weather_df %>% mutate(ci = NA)

for (i in 1:4) {
  forecasted_1w <- fit %>%
    forecast(new_data = test_weekly_weather_df %>% head(i) %>% tail(1)) %>%
    as_tibble() %>%
    select(date_admitted, .mean, n) %>%
    rename(ci = n, n = .mean)

  forecast_1w_weather_df %<>% bind_rows(forecasted_1w)

  fit %<>% refit(
    incidence_weekly_weather_df %>%
      filter_index(~ sprintf("2019 W0%d", i)) %>%
      mutate(ci = NA),
    reestimate = FALSE
  )
}

ggplot(mapping = aes(x = date_admitted)) +
  stat_lineribbon(
    data = forecast_1w_weather_df,
    aes(ydist = ci),
    linewidth = .5,
    .width = c(0.8, 0.95),
    color = "blue"
  ) +
  geom_line(
    data = test_weekly_weather_df,
    aes(y = n)
  ) +
  scale_fill_brewer() +
  scale_x_yearweek(limit = c(as.Date("2018-12-01"), as.Date("2019-02-01")))

### Accuracy
actual <- incidence_weekly_df %>%
  filter(year(date_admitted) == 2019) %>%
  head(4) %>%
  pull(n)
forecasted <- forecast_1w_df %>%
  filter(year(date_admitted) == 2019) %>%
  head(4) %>%
  pull(n)

sprintf(
  "RMSE: %f",
  sqrt(mean((actual - forecasted)^2))
)
sprintf(
  "MAE: %f",
  mean(abs(actual - forecasted))
)
```
