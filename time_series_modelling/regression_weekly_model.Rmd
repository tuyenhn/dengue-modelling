---
output: 
  html_document:
    df_print: paged
    toc: yes
    theme: journal
---

**Knitted at: `r Sys.time()`**

# Libraries

```{r message=FALSE, warning=FALSE}
library(tidyverse)
library(magrittr)
library(tscount)
library(tsibble)
library(feasts)

library(pbapply)
library(parallel)
library(foreach)
library(doParallel)
```

# Settings
```{r}
theme_set(theme_bw())
```


# Data ingestion

```{r}
source("../data_weekly.R", chdir = TRUE)
```


## Incidence data

```{r}
# ggplot(incidence_weekly_df, aes(x = date_admitted, y = n)) +
#   geom_line() +
#   scale_x_yearweek(
#     "Date",
#     breaks = yearweek(paste0(seq(2000, 2023, 1), " W01")), minor_breaks = NULL,
#     labels = as.character(seq(2000, 2023, 1))
#   ) +
#   scale_y_continuous("Case admitted") +
#   ggtitle("Dengue weekly incidence")

# ggsave("weekly_incidence_ts.svg", width = 12, height = 7)
```

### Train test split
```{r}
# incidence_weekly_df %>%
#   filter_index("2000 W01" ~ "2019 W52") %>%
#   ggplot(aes(x = date_admitted, y = n)) +
#   geom_line() +
#   geom_vline(xintercept = as.Date(yearweek("2019 W01")), color = "red") +
#   scale_x_yearweek(
#     "Date",
#     breaks = yearweek(paste0(seq(2000, 2020, 1), " W01")), minor_breaks = NULL,
#     labels = as.character(seq(2000, 2020, 1))
#   ) +
#   scale_y_continuous("Case admitted") +
#   ggtitle("Dengue weekly incidence")

# ggsave("weekly_incidence_split_ts.svg", width = 12, height = 7)
```


```{r}
train_weekly_df <- train_weekly_df %>% bind_rows(val_weekly_df)
train_weekly_df %>% tail()

train_weekly_weather_df <- train_weekly_weather_df %>% bind_rows(val_weekly_weather_df)
train_weekly_weather_df %>% tail()
```

# Correlation analysis

## CCF

"The lag k value returned by ccf(x, y) estimates the correlation between x[t+k] and y[t]."

```{r}
incidence_weekly_weather_df %>%
  CCF(n, t2m, lag_max = 52) %>%
  autoplot()

incidence_weekly_weather_df %>%
  mutate(t2m_lagged = lag(t2m, 27)) %>%
  filter(year(date_admitted) < 2019) %>%
  CCF(n, t2m_lagged, lag_max = 52) %>%
  autoplot()

incidence_weekly_weather_df %>%
  CCF(n, precip, lag_max = 52) %>%
  autoplot()

incidence_weekly_weather_df %>%
  mutate(precip_lagged = lag(precip, 13)) %>%
  filter(year(date_admitted) < 2019) %>%
  CCF(n, precip_lagged, lag_max = 52) %>%
  autoplot()
```

```{r}
# train_weekly_weather_df <- incidence_weekly_weather_df %>%
#   mutate(
#     t2m_lagged = lag(t2m, 27),
#     precip_lagged = lag(precip, 10)
#   ) %>%
#   filter_index("2000 W01" ~ "2018 W52")
#
# test_weekly_weather_df <- incidence_weekly_weather_df %>%
#   mutate(
#     t2m_lagged = lag(t2m, 27),
#     precip_lagged = lag(precip, 10)
#   ) %>%
#   filter(year(date_admitted) == 2019) %>%
#   head(4)
```

# Modelling

## Performance checking framework

```{r}
model_perfs <- tibble(
  model = character(),
  RMSE = numeric(),
  MAE = numeric()
)

forecast_perf <- function(forecast, actual, model_name) {
  rmse <- sqrt(mean((actual - forecast)^2))
  mae <- mean(abs(actual - forecast))

  print(sprintf("Test RMSE: %f", rmse))
  print(sprintf("Test MAE: %f", mae))

  model_perfs <<- model_perfs %>%
    bind_rows(tibble(model = model_name, RMSE = rmse, MAE = mae))
}

forecast_plot_default <- function(fit_df, actual_df, plot_title) {
  ggplot(actual_df) +
    geom_line(aes(x = date_admitted, y = n)) +
    forecast_layer(fit_df) +
    scale_x_yearweek(
      "Date",
      breaks = as.Date(actual_df$date_admitted[seq(1, 52, 3)]),
      labels = as.character(actual_df$date_admitted[seq(1, 52, 3)]) %>% str_extract("W\\d+"),
      minor_breaks = NULL
    ) +
    scale_y_continuous("Incidence") +
    ggtitle(plot_title)
}
```

## Model fitting and forecast framework


```{r}
recur_miso <- function(
    train_set, test_set,
    start_indices,
    model = list(), xreg_names = NULL,
    horizon = 4,
    link = c("identity", "log"), distr = c("poisson", "nbinom"),
    cl = NULL) {
  if (!missing(cl)) {
    clusterEvalQ(cl, suppressPackageStartupMessages(library(magrittr)))
    clusterEvalQ(cl, suppressPackageStartupMessages(library(dplyr)))
    clusterEvalQ(cl, library(tscount))
    clusterExport(cl, c("train_set", "test_set"), environment())
  }
  distr <- match.arg(distr)
  link <- match.arg(link)

  pbapply::pblapply(start_indices, \(start_idx) {
    train_df <- train_set %>%
      bind_rows(test_set %>% slice_head(n = start_idx)) %>%
      tail(nrow(train_set))

    if (!is.null(xreg_names)) {
      xreg <- train_df %>%
        as_tibble() %>%
        select(all_of(xreg_names)) %>%
        as.matrix()
      newxreg <- test_set %>%
        tail(52 - start_idx) %>%
        head(horizon) %>%
        as_tibble() %>%
        select(all_of(xreg_names)) %>%
        as.matrix()
    } else {
      xreg <- NULL
      newxreg <- NULL
    }

    fit <- tsglm(train_df$n, model = model, link = link, distr = distr, xreg = xreg)
    pred <- predict(fit, horizon, newobs = NULL, newxreg = newxreg)

    tibble(
      startweek = start_idx,
      actualweek = start_idx + (1:horizon - 1),
      preds = (pred$pred),
      lowers = (pred$interval[, "lower"]),
      uppers = (pred$interval[, "upper"]),
    )
  }, cl = cl) %>% list_c()
}


forecast_layer <- function(frcst_df) {
  # frcst_df <- forecast_df
  frcst_df %<>% group_by(startweek) %>% group_split()

  layers <- lapply(
    frcst_df,
    \(df)
    c(layer(
      data = df,
      geom = "ribbon", stat = "identity", position = "identity",
      mapping = aes(x = date, ymin = lowers, ymax = uppers),
      params = list(alpha = 0.5, fill = "pink")
    ), layer(
      data = df,
      geom = "line", stat = "identity", position = "identity",
      mapping = aes(x = date, y = preds), params = list(color = "red")
    ))
  )
  layers
}
```

```{r}
unregister_dopar <- function() {
  env <- foreach:::.foreachGlobals
  rm(list = ls(name = env), pos = env)
}
```


## Poisson
```{r}
poi_covar_forecast_df <- recur_miso(
  train_weekly_weather_df, test_weekly_weather_df,
  seq(1, 49, 3),
  model = list(past_obs = 1),
  link = "log", distr = "poisson"
) %>%
  mutate(date = yearweek(paste0("2019 W", actualweek)), .before = everything())

forecast_plot_default(
  poi_covar_forecast_df, test_weekly_df,
  "4 week forecast - Poisson regression 1-week lag"
)

ggsave("./svgs/forecast_poisson_l1w.svg", height = 7, width = 10)
```


```{r}
poi_1wl_pre_perf <- poi_covar_forecast_df %>%
  select(date, preds) %>%
  left_join(test_weekly_df, by = c("date" = "date_admitted"))

forecast_perf(
  poi_1wl_pre_perf$preds,
  poi_1wl_pre_perf$n, "Poisson 1-week lag"
)
```


### Auto lagged

```{r}
unregister_dopar()

cl <- makeForkCluster(9)
registerDoParallel(cl)

auto_lagged_df <-  foreach(lag = 1:52) %dopar% {
  forecast_df <- recur_miso(
    train_weekly_weather_df, test_weekly_weather_df,
    seq(1, 49, 3),
    model = list(past_obs = lag),
    link = "log", distr = "poisson"
  ) %>%
    mutate(date = yearweek(paste0("2019 W", actualweek)), .before = everything())

  pre_perf <- forecast_df %>%
    select(date, preds) %>%
    left_join(test_weekly_df, by = c("date" = "date_admitted"))

  rmse <- sqrt(mean((pre_perf$n - pre_perf$preds)^2))
  mae <- mean(abs(pre_perf$n - pre_perf$preds))

  tibble(model = sprintf("Poisson %d-week lag", lag), RMSE = rmse, MAE = mae, lag = lag)
}

stopCluster(cl)
```



```{r}
lag_dfs %>%
  list_c() %>%
  ggplot() +
  geom_col(aes(x = lag, y = RMSE))

ggsave("./svgs/forecast_poisson_all_lags.svg", width = 10, height = 7)
```


### Weather lagged
 
#### T2m 

```{r}
unregister_dopar()

cl <- makeCluster(10)
clusterEvalQ(cl, library(dplyr))
clusterEvalQ(cl, library(tsibble))
clusterEvalQ(cl, library(purrr))
clusterEvalQ(cl, library(tscount))
registerDoParallel(cl)

t2m_lag_df <- foreach(lag = 1:52) %dopar% {
  train_df <- incidence_weekly_weather_df %>%
    mutate(t2m = lag(t2m, lag)) %>%
    filter_index("2000 W01" ~ "2018 W52")

  test_df <- incidence_weekly_weather_df %>%
    mutate(t2m = lag(t2m, lag)) %>%
    filter_index("2019 W01" ~ "2019 W52")


  forecast_df <- recur_miso(
    train_df, test_df,
    seq(1, 49, 3),
    model = list(past_obs = 1), xreg_names = c("t2m"),
    link = "log", distr = "poisson"
  ) %>%
    mutate(date = yearweek(paste0("2019 W", actualweek)), .before = everything())

  pre_perf <- forecast_df %>%
    select(date, preds) %>%
    left_join(test_weekly_df, by = c("date" = "date_admitted"))

  rmse <- sqrt(mean((pre_perf$n - pre_perf$preds)^2))
  mae <- mean(abs(pre_perf$n - pre_perf$preds))

  tibble(model = sprintf("Poisson %d-week t2m lag", lag), RMSE = rmse, MAE = mae, lag = lag)
}

stopCluster(cl)
```

```{r}
t2m_lag_df %>%
  list_c() %>%
  ggplot() +
  geom_col(aes(x = lag, y = RMSE))

ggsave("./svgs/forecast_poisson_all_t2m_lags.svg", width = 10, height = 7)
```



### Multi lagged Precip

```{r}
for (i in 1:52) {
  train_df <- incidence_weekly_weather_df %>%
    mutate(precip_lagged = lag(precip, i)) %>%
    filter_index("2000 W01" ~ "2018 W52")

  test_df <- incidence_weekly_weather_df %>%
    mutate(precip_lagged = lag(precip, i)) %>%
    filter(year(date_admitted) == 2019) %>%
    head(4)

  lagged_fit <- glm(
    n ~ date_admitted + precip_lagged,
    family = poisson(), data = train_df
  )

  forecast_perf(
    lagged_fit, test_df$n,
    newdata = test_df, sprintf("Poisson Precip lagged %d", i),
    plot = FALSE
  )
}
```

```{r}
model_perfs %>%
  filter(startsWith(model, "Poisson Precip lagged")) %>%
  mutate(lag = str_extract(model, "\\d+$") %>% as.numeric()) %>%
  ggplot(aes(x = lag, y = RMSE)) +
  geom_col() +
  scale_x_continuous(breaks = seq(1, 52, 2), minor_breaks = NULL)
```

## Negative Binomial

```{r}
nb_fit <- MASS::glm.nb(
  n ~ date_admitted + t2m + precip,
  data = train_weekly_weather_df
)

fit_perf(nb_fit, train_weekly_weather_df$n)

forecast <- tsibble(
  date_admitted = test_weekly_weather_df$date_admitted, index = date_admitted
) %>% bind_cols(
  as_tibble(investr::predFit(
    nb_fit,
    newdata = test_weekly_weather_df,
    interval = "confidence",
  ) %>% exp())
)


ggplot(
  incidence_weekly_df %>%
    left_join(forecast, by = "date_admitted"), aes(x = date_admitted)
) +
  geom_line(aes(y = n)) +
  geom_ribbon(aes(ymin = lwr, ymax = upr), fill = "pink") +
  geom_line(aes(y = fit), color = "red") +
  scale_x_yearweek("Week", limits = c(as.Date("2018-01-01"), as.Date("2019-01-21"))) +
  scale_y_continuous("Incidence") +
  ggtitle("4 week forecast - NB")

ggsave("forecast_nb_4w.svg", width = 10, height = 7)

forecast_perf(
  nb_fit, test_weekly_weather_df$n,
  newdata = test_weekly_weather_df, "NB"
)
```

### Lagged

```{r}
nb_lagged_fit <- MASS::glm.nb(
  n ~ date_admitted + t2m_lagged + precip_lagged,
  data = train_weekly_weather_df
)

fit_perf(nb_lagged_fit, train_weekly_weather_df$n)

forecast <- tsibble(
  date_admitted = test_weekly_weather_df$date_admitted, index = date_admitted
) %>% bind_cols(
  as_tibble(investr::predFit(
    nb_lagged_fit,
    newdata = test_weekly_weather_df,
    interval = "confidence",
  ) %>% exp())
)

ggplot(
  incidence_weekly_df %>%
    left_join(forecast, by = "date_admitted"), aes(x = date_admitted)
) +
  geom_line(aes(y = n)) +
  geom_ribbon(aes(ymin = lwr, ymax = upr), fill = "pink") +
  geom_line(aes(y = fit), color = "red") +
  scale_x_yearweek("Week", limits = c(as.Date("2018-01-01"), as.Date("2019-01-21"))) +
  scale_y_continuous("Incidence") +
  ggtitle("4 week forecast - NB lagged covariables")

ggsave("forecast_nb_lagged_4w.svg", width = 10, height = 7)

forecast_perf(
  nb_lagged_fit, test_weekly_weather_df$n,
  newdata = test_weekly_weather_df, "NB lagged"
)
```

### Multi lagged T2m

```{r}
for (i in 1:52) {
  train_df <- incidence_weekly_weather_df %>%
    mutate(t2m_lagged = lag(t2m, i)) %>%
    filter_index("2000 W01" ~ "2018 W52")

  test_df <- incidence_weekly_weather_df %>%
    mutate(t2m_lagged = lag(t2m, i)) %>%
    filter(year(date_admitted) == 2019) %>%
    head(4)

  lagged_fit <- MASS::glm.nb(
    n ~ date_admitted + t2m_lagged,
    data = train_weekly_weather_df
  )

  forecast_perf(
    lagged_fit, test_df$n,
    newdata = test_df, sprintf("NB T2m lagged %d", i),
    plot = FALSE
  )
}
```

```{r}
model_perfs %>%
  filter(startsWith(model, "NB T2m lagged")) %>%
  mutate(lag = str_extract(model, "\\d+$") %>% as.numeric()) %>%
  ggplot(aes(x = lag, y = RMSE)) +
  geom_col() +
  scale_x_continuous(breaks = seq(1, 52, 2), minor_breaks = NULL)
```

### Multi lagged Precip

```{r}
for (i in 1:52) {
  train_df <- incidence_weekly_weather_df %>%
    mutate(precip_lagged = lag(precip, i)) %>%
    filter_index("2000 W01" ~ "2018 W52")

  test_df <- incidence_weekly_weather_df %>%
    mutate(precip_lagged = lag(precip, i)) %>%
    filter(year(date_admitted) == 2019) %>%
    head(4)

  lagged_fit <- MASS::glm.nb(
    n ~ date_admitted + precip_lagged,
    data = train_weekly_weather_df
  )


  forecast_perf(
    lagged_fit, test_df$n,
    newdata = test_df, sprintf("NB Precip lagged %d", i),
    plot = FALSE
  )
}
```

```{r}
model_perfs %>%
  filter(startsWith(model, "NB Precip lagged")) %>%
  mutate(lag = str_extract(model, "\\d+$") %>% as.numeric()) %>%
  ggplot(aes(x = lag, y = RMSE)) +
  geom_col() +
  scale_x_continuous(breaks = seq(1, 52, 2), minor_breaks = NULL)
```


# Comparison

```{r}
model_perfs
```

```{r}
model_perfs %>% write_csv("glm_models_perf.csv")
```
