---
title: "Meteorological covariables analysis"
output: 
  html_document:
    df_print: paged
    toc: true
    toc_float: true
    theme: journal
---

```{r setup}
knitr::opts_knit$set(root.dir = "/home/tuyenhn-wsl/dengue-modelling")
```


# Library

```{r}
.pkgs <- c("sf", "stars", "rsample", "future", "furrr", "modelr", "distributional", "GGally")
xfun::pkg_attach(.pkgs, message = FALSE)

source("utils/data_weekly.R", chdir = TRUE)
source("utils/data_weekly_weather.R", chdir = TRUE)
source("utils/covar_fns.R")
source("utils/cross_validation.R")
source("utils/boot_pi.R")

set.seed(123)
```

# Weather data

## Temperature data

```{r}
plot_covar(hcmc_temp_df, "Temperature (°C)", "Weekly mean 2m temperature - ERA5 reanalysis")

ggsave("./svgs/weekly_t2m_ts.svg", width = 10, height = 7)

hist(hcmc_temp_df$t2m)
```

## Precipitation data

```{r}
plot_covar(hcmc_precip_df, "Precipitation (mm)", "Weekly total precipitation ERA5 - reanalysis")

ggsave("./svgs/weekly_precip_ts.svg", width = 10, height = 7)

hist(hcmc_precip_df$precip)
```

## Humidity data

```{r}
plot_covar(hcmc_rh_df, "Relative Humidity (%)", "Weekly mean relative humidity - ERA5 reanalysis")

ggsave("./svgs/weekly_rh_ts.svg", width = 10, height = 7)

hist(hcmc_rh_df$rh)
```

## Specific humidity
```{r}
plot_covar(hcmc_sh_df, "Specific Humidity (g/kg)", "Weekly mean specific humidity - ERA5 reanalysis")

ggsave("./svgs/weekly_sh_ts.svg", width = 10, height = 7)

hist(hcmc_sh_df$sh)
```

## Wind speed
```{r}
plot_covar(
  hcmc_ws_df,
  "Wind speed intensity at 10 meters (m/s)",
  "Weekly mean wind speed intensity - ERA5 reanalysis"
)

ggsave("./svgs/weekly_ws_ts.svg", width = 10, height = 7)

hist(hcmc_ws_df$ws)
```

## Hydrological balance

Daily hydrological balance (`evaporation - precipitation`) If `hb`>0, the area is accumulates water. If `hb` <0, the area loses water (in m)

```{r}
plot_covar(
  hcmc_hb_df,
  "Hydrological balance",
  "Weekly total hydrological balance - ERA5 reanalysis",
  layer(
    geom = "hline", stat = "identity", position = "identity",
    params = list(yintercept = 0, color = "red", linetype = "dashed")
  )
)

ggsave("./svgs/weekly_hb_ts.svg", width = 10, height = 7)

hist(hcmc_hb_df$hb)
```

## Solar radiation
Accumulated solar radiation downwards. This parameter is the amount of solar radiation (also known as shortwave radiation) that reaches a horizontal plane at the surface of the Earth. It is important to highlight that this parameter comprises both direct and diffuse solar radiation. (J/m2)

```{r}
plot_covar(
  hcmc_ssdr_df,
  "Accumulated solar radiation downwards (J/m²)",
  "Weekly total accumulated solar radiation downwards - ERA5 reanalysis"
)

ggsave("./svgs/weekly_ssdr_ts.svg", width = 10, height = 7)

hist(hcmc_ssdr_df$ssdr)
```

## Max and min temperature

```{r}
plot_covar(
  hcmc_mx_mn2t24_df %>% pivot_longer(-date) %>% relocate(value, .after = date),
  "Temperature (°C)",
  "Weekly mean maximum and minimum temperature - ERA5 reanalysis",
  list(),
  color = name
)

ggsave("./svgs/weekly_mx_mn2t24_ts.svg", width = 10, height = 7)

hist(hcmc_mx_mn2t24_df$mn2t24)
hist(hcmc_mx_mn2t24_df$mx2t24)
```

## Max and min relative humidity

```{r}
plot_covar(
  hcmc_mx_mnrh24_df %>% pivot_longer(-date) %>% relocate(value, .after = date),
  "Relative humidity",
  "Weekly mean maximum and minimum relative humidity - ERA5 reanalysis",
  list(),
  color = name
)

ggsave("./svgs/weekly_mx_mnrh24_ts.svg", width = 10, height = 7)

hist(hcmc_mx_mnrh24_df$mnrh24)
hist(hcmc_mx_mnrh24_df$mxrh24)
```

## Max and min specific humidity

```{r}
plot_covar(
  hcmc_mx_mnsh24_df %>% pivot_longer(-date) %>% relocate(value, .after = date),
  "Specific humidity",
  "Weekly mean maximum and minimum specific humidity - ERA5 reanalysis",
  scale_alpha_continuous(guide = "none"),
  color = name, alpha = 0.9
)

ggsave("./svgs/weekly_mx_mnsh24_ts.svg", width = 10, height = 7)

hist(hcmc_mx_mnsh24_df$mnsh24)
hist(hcmc_mx_mnsh24_df$mxsh24)
```

## Standardized Precipitation Index 
Daily SPI shows how wet/dry was the weather compared to the usual using for the last 30 days. Data is aggregated to weekly using averaging.
(Monthly SPI shows how wet/dry was the weather compared to the usual in the whole month)

```{r}
plot_covar(
  hcmc_spi_df, "Average SPI", "Weekly mean SPI",
  layer(
    geom = "hline", stat = "identity", position = "identity",
    params = list(yintercept = 0, color = "red", linetype = "dashed")
  )
)

ggsave("./svgs/weekly_spi_ts.svg", width = 10, height = 7)

hist(hcmc_spi_df$spi_daily)
```

## Standardized Precipitation-Evaporation Index  
It is almost the same as the SPI, but including the evaporation in the index. The information that this variable gives is the same as SPI (How humid/dry is the weather conditions compare to the usual conditions)

```{r}
plot_covar(
  hcmc_spei_df, "Average SPEI", "Weekly mean SPEI",
  layer(
    geom = "hline", stat = "identity", position = "identity",
    params = list(yintercept = 0, color = "red", linetype = "dashed")
  )
)

ggsave("./svgs/weekly_spei_ts.svg", width = 10, height = 7)

hist(hcmc_spei_df$spei_daily)
```


# Covariable individual performance

```{r}
incidence_ww_trunc_df <- calculate_lags(incidence_weekly_weather_df, "n", 1) %>%
  filter_index("2004 W01" ~ "2019 W52") %>%
  as_tibble() %>%
  mutate(year = year(date_admitted)) %>%
  select(-date_admitted) %>%
  rowid_to_column()

dat_split <- initial_split(incidence_ww_trunc_df, prop = 3 / 4, strata = year)
train_dat <- training(dat_split)
test_dat <- testing(dat_split)

covar_names <- incidence_weekly_weather_df %>%
  as_tibble() %>%
  select(-c(date_admitted, n)) %>%
  colnames()
covar_names
```


```{r}
plan(multisession, workers = 8)

covar_cv_perfs <- future_map(
  covar_names, \(covar) rep_kfold_cv_covar(train_dat, covar),
  .options = furrr_options(seed = TRUE), .progress = TRUE
) %>%
  list_c() %>%
  mutate(covar = str_split_i(model, "w/", 2), .after = model)

plan(sequential)
```

```{r}
covar_cv_perfs
```

```{r}
covar_cv_perfs %>%
  select(-model) %>%
  pivot_longer(-covar) %>%
  unnest(value) %>%
  group_by(name, covar) %>%
  mutate(group = dense_rank(value)) %>%
  arrange(covar) %>%
  ggplot(aes(x = value, y = covar, color = name)) +
  geom_point(alpha = 0.9) +
  geom_path(aes(group = group), alpha = 0.9) +
  stat_summary(
    fun = mean, geom = "errorbar", aes(xmax = ..x.., ymin = ..x..),
    width = 0.75, color = "black"
  ) +
  scale_y_discrete("Model") +
  scale_x_continuous("Average performance across 5-repetition 5-fold CV") +
  scale_color_discrete(guide = "none") +
  facet_wrap(~name, nrow = 1, scales = "free_x")
```


# Relationship with incidence

```{r fig.height=7, fig.width=10}
incidence_weekly_weather_df %>%
  drop_na() %>%
  pivot_longer(-c(date_admitted, n)) %>%
  ggplot(aes(x = value, y = log(n))) +
  geom_point() +
  geom_smooth(method = "lm", formula = y ~ x, se = FALSE) +
  facet_wrap(~name, scales = "free_x")
```

```{r fig.height=10, fig.width=10}
# Pearson correlation coefficient
incidence_weekly_weather_df %>%
  drop_na() %>%
  mutate(n = log(n)) %>%
  ggpairs(
    columns = 2:17,
    lower = list(continuous = wrap("density", alpha = 0.5)),
    progress = FALSE
  )
```

```{r fig.height=10, fig.width=10}
incidence_weekly_weather_df %>%
  drop_na() %>%
  mutate(n = log(n)) %>%
  ggpairs(
    columns = 2:15,
    lower = list(continuous = wrap("points", alpha = 0.1)),
    progress = FALSE
  )
```

```{r fig.height=10, fig.width=10}
incidence_weekly_weather_df %>%
  drop_na() %>%
  mutate(n = log(n)) %>%
  ggpairs(
    columns = 2:15,
    lower = list(continuous = wrap(ggally_smooth_lm, color = "red")),
    progress = FALSE
  )
```
