---
output: 
  html_document:
    df_print: paged
    toc: yes
    theme: journal
---

**Knitted at: `r Sys.time()`**

# Library

```{r message=FALSE, warning=FALSE}
library(tidyverse)
library(magrittr)

library(feasts)
library(tsibble)
library(fable.prophet)
library(fabletools)
library(fable)

library(lubridate)

library(ggdist)

library(sf)
library(stars)
```

```{r}
theme_set(theme_bw())
```


# Data ingestion

```{r}
source("./data_weekly.R")
```


## Incidence data

```{r}
ggplot(incidence_weekly_df, aes(x = date_admitted, y = n)) +
  geom_line()
```

## HCMC shape

```{r}
ggplot() +
  geom_sf(data = hcmc_shp_w_buff) +
  geom_sf(data = hcmc_shp)
```

## Weather data

Data information: ![](era5_req.png)
```{r}
raw_weather
```

### Temperature data

```{r}
hcmc_temp_df %>%
  ggplot(aes(x = date, y = t2m)) +
  geom_line() +
  geom_smooth() +
  scale_x_yearweek("Week") +
  scale_y_continuous("2m temperature") +
  ggtitle("Weekly 2m temperature ERA5 reanalysis")

ggsave("weekly_t2m_ts.svg", width = 10, height = 7)

hist(hcmc_temp_df$t2m)

hist(hcmc_temp_df$scaled_t2m)
```

### Precipitation data

```{r}
hcmc_precip_df %>%
  ggplot(aes(x = date, y = precip)) +
  geom_line() +
  geom_smooth() +
  scale_x_yearweek("Week") +
  scale_y_continuous("Total precipitation") +
  ggtitle("Weekly Total precipitation ERA5 reanalysis")

ggsave("weekly_precip_ts.svg", width = 10, height = 7)

hist(hcmc_precip_df$precip)
hist(hcmc_precip_df$scaled_precip)
```

```{r}
incidence_weekly_weather_df
```

# Modelling

## Performance checking framework

```{r}
fit_perf <- function(fit, actual) {
  print(summary(fit))

  fitted <- fitted(fit)

  fitted %>% plot(type = "l")

  print(sprintf(
    "Train RMSE: %f",
    sqrt(mean((actual - fitted)^2))
  ))
  print(sprintf(
    "Train MAE: %f",
    mean(abs(actual - fitted))
  ))

  print(train_weekly_weather_df %>%
    mutate(fitted = fitted) %>%
    ggplot(aes(x = date_admitted)) +
    geom_line(aes(y = n)) +
    geom_line(aes(y = fitted), color = "red"))
}

model_perfs <- tibble(
  model = character(),
  RMSE = numeric(),
  MAE = numeric()
)

forecast_perf <- function(forecast, actual, model_name) {
  forecast %>% plot(type = "l")

  rmse <- sqrt(mean((actual - forecast)^2))
  mae <- mean(abs(actual - forecast))

  print(sprintf("Test RMSE: %f", rmse))
  print(sprintf("Test MAE: %f", mae))

  model_perfs <<- model_perfs %>% bind_rows(tibble(model = model_name, RMSE = rmse, MAE = mae))

  print(test_weekly_weather_df %>%
    mutate(forecast = forecast) %>%
    ggplot(aes(x = date_admitted)) +
    geom_line(aes(y = n)) +
    geom_line(aes(y = forecast), color = "red"))
}
```

## Forecast plotting
```{r}
mrdp <- train_weekly_df %>% tail(1)
mrdp_ci <- distributional::dist_normal(mrdp$n, 0)
dimnames(mrdp_ci) <- "n"

forecast_layer <- function(fit, h = 4) {
  fit %>%
    forecast(h = h) %>%
    append_row(-1) %>%
    mutate(
      n = case_when(is.na(n) ~ mrdp_ci, .default = n),
      .mean = case_when(is.na(.mean) ~ mrdp$n, .default = .mean)
    ) %>%
    as_fable(c(".mean"), "n") %>%
    autolayer()
}
```


## Mean

```{r}
mean_fit <- train_weekly_df %>% model(MEAN(n))
mean_fitted <- fitted(mean_fit)$.fitted[[1]]

mean_fit %>%
  forecast(h = 4) %>%
  autoplot(incidence_weekly_df) +
  geom_segment(
    aes(
      x = as.Date("2018-01-01"), xend = as.Date("2019-01-01"),
      y = mean_fitted, yend = mean_fitted
    ),
    color = "blue", linetype = "dashed", linewidth = 0.3
  ) +
  scale_x_yearweek("Week", limits = c(as.Date("2018-01-01"), as.Date("2019-01-21"))) +
  scale_y_continuous("Incidence") +
  ggtitle("4 week forecast - MEAN")

ggsave("forecast_mean_4w.svg", width = 10, height = 7)

forecast_perf(
  mean_fit %>% forecast(h = 4) %>% as_tibble() %>% pull(.mean),
  test_weekly_weather_df %>% pull(n),
  "MEAN"
)
```

## Seasonal mean

```{r}
smean_forecast <- train_weekly_df %>%
  as_tibble() %>%
  mutate(
    week = week(date_admitted),
    year_w = year(date_admitted) - 1999,
    year_w_exp = exp(year_w),
  ) %>%
  group_by(week) %>%
  summarise(
    smean = mean(n),
    w_smean = weighted.mean(n, year_w),
    w_exp_smean = weighted.mean(n, year_w_exp)
  ) %>%
  mutate(
    date_admitted = seq.Date(
      as.Date("2019-01-01"),
      as.Date("2019-12-31"),
      by = "1 week"
    ) %>% yearweek()
  ) %>%
  select(-week) %>%
  head(-1) %>%
  as_tsibble(index = "date_admitted")

smean_forecast %>%
  pivot_longer(-date_admitted) %>%
  ggplot(aes(x = date_admitted)) +
  geom_line(aes(y = value, color = name, group = name)) +
  geom_line(data = incidence_weekly_df, mapping = aes(y = n)) +
  scale_x_yearweek("Week", limits = c(as.Date("2018-01-01"), as.Date("2019-02-01"))) +
  scale_y_continuous("Incidence") +
  ggtitle("4 week forecast - Seasonal mean")

ggsave("forecast_mean_4w.svg", width = 10, height = 7)

forecast_perf(
  smean_forecast %>% head(4) %>% as_tibble() %>% pull(smean),
  test_weekly_weather_df %>% pull(n),
  "Seasonal mean"
)

forecast_perf(
  smean_forecast %>% head(4) %>% as_tibble() %>% pull(w_smean),
  test_weekly_weather_df %>% pull(n),
  "Seasonal mean weighted"
)

forecast_perf(
  smean_forecast %>% head(4) %>% as_tibble() %>% pull(w_exp_smean),
  test_weekly_weather_df %>% pull(n),
  "Seasonal mean exponentially weighted"
)
```

## NAIVE

```{r}
naive_fit <- train_weekly_df %>% model(NAIVE(n))

ggplot(incidence_weekly_df, aes(x = date_admitted, y = n)) +
  forecast_layer(naive_fit) +
  geom_line() +
  scale_x_yearweek("Week", limits = c(as.Date("2018-01-01"), as.Date("2019-01-21"))) +
  scale_y_continuous("Incidence") +
  ggtitle("4 week forecast - NAIVE")

ggsave("forecast_naive_4w.svg", width = 10, height = 7)

forecast_perf(
  naive_fit %>% forecast(h = 4) %>% as_tibble() %>% pull(.mean),
  test_weekly_weather_df %>% pull(n),
  "NAIVE"
)
```

## SNAIVE

```{r}
snaive_fit <- train_weekly_df %>% model(SNAIVE(n))

snaive_fit %>%
  forecast(h = 4) %>%
  autoplot(incidence_weekly_df) +
  scale_x_yearweek("Week", limits = c(as.Date("2018-01-01"), as.Date("2019-01-21"))) +
  scale_y_continuous("Incidence") +
  ggtitle("4 week forecast - SNAIVE")

ggsave("forecast_snaive_4w.svg", width = 10, height = 7)

forecast_perf(
  snaive_fit %>% forecast(h = 4) %>% as_tibble() %>% pull(.mean),
  test_weekly_weather_df %>% pull(n),
  "SNAIVE"
)
```

## Drift

```{r}
drift_fit <- train_weekly_df %>% model(RW(n ~ drift()))

ggplot(incidence_weekly_df, aes(x = date_admitted, y = n)) +
  forecast_layer(drift_fit) +
  geom_line() +
  scale_x_yearweek("Week", limits = c(as.Date("2018-01-01"), as.Date("2019-01-21"))) +
  scale_y_continuous("Incidence") +
  ggtitle("4 week forecast - DRIFT")

ggsave("forecast_drift_4w.svg", width = 10, height = 7)

forecast_perf(
  drift_fit %>% forecast(h = 4) %>% as_tibble() %>% pull(.mean),
  test_weekly_weather_df %>% pull(n),
  "Drift"
)
```

## AR

```{r}
ar_fit <- train_weekly_df %>% model(AR(n))

report(ar_fit)
cat("\n\n")

ggplot(incidence_weekly_df, aes(x = date_admitted, y = n)) +
  forecast_layer(ar_fit) +
  geom_line() +
  scale_x_yearweek("Week", limits = c(as.Date("2018-01-01"), as.Date("2019-01-21"))) +
  scale_y_continuous("Incidence") +
  ggtitle("4 week forecast - AR(10)")

ggsave("forecast_ar10_4w.svg", width = 10, height = 7)

forecast_perf(
  ar_fit %>% forecast(h = 4) %>% as_tibble() %>% pull(.mean),
  test_weekly_weather_df %>% pull(n),
  "AR(10)"
)
```

## MA

```{r}
ma_fit <- train_weekly_df %>% model(ARIMA(n ~ pdq(0, 0, 6) + PDQ(0, 0, 0)))

report(ma_fit)
cat("\n\n")

ggplot(incidence_weekly_df, aes(x = date_admitted, y = n)) +
  forecast_layer(ma_fit) +
  geom_line() +
  scale_x_yearweek("Week", limits = c(as.Date("2018-01-01"), as.Date("2019-01-21"))) +
  scale_y_continuous("Incidence") +
  ggtitle("4 week forecast - MA(6)")

ggsave("forecast_ma6_4w.svg", width = 10, height = 7)

forecast_perf(
  ma_fit %>% forecast(h = 4) %>% as_tibble() %>% pull(.mean),
  test_weekly_weather_df %>% pull(n),
  "MA(6)"
)
```

# Comparison
```{r}
model_perfs %>% arrange(RMSE)
```

```{r}
model_perfs %>% write_csv("simple_models_perf.csv")
```
